<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
    </head>
    <body>
        <h1>Importar Productos desde FakeStore a Firebase</h1>
        <button id="importBtn" onclick=""> Importar Productos</button>
        <div id="container-products"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
       
        const firebaseConfig = {
          apiKey: "AIzaSyAlAObJTfegVsHitoaXdQCpM71R3u-pcLY",
          authDomain: "inventario-36357.firebaseapp.com",
          projectId: "inventario-36357",
          storageBucket: "inventario-36357.firebasestorage.app",
          messagingSenderId: "286137968560",
          appId: "1:286137968560:web:8e8b7abfee1b6595219875"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db=getFirestore(app)
        
        // Funcion para obtener productos desde FakeStore API
        const getFakeStoreData =async () => {
            try {
                const response = await fetch('https://fakestoreapi.com/products')
                const productos = await response.json()
                await saveToFirestore(productos)
                getProductsFirebase()
            } catch (error) {
                console.error(' Error al obtener los productos ', error);
            }
        }
        
       const getProductsFirebase=async () => {
        const querySnapshot=await getDocs(collection(db,'productos'))
        console.log('querySnapshot', querySnapshot);
        
        const productos=  querySnapshot.docs.map(doc=>({...doc.data(), id:doc.id}))
        displayProducts(productos)
       }
        // Funcion para mostrar los productos
        const displayProducts=async (productos)=>{

            document.getElementById('container-products').innerHTML= productos.map((producto,index)=>
            `
            <img height='120px' src=${producto.image} alt="">
            <div>
                <button id="editar-${index}"> editar</button>
                <button id="eliminar-${index}"> eliminar</button>
            </div>
            `)
            productos.forEach((producto, index)=>{
                document.getElementById(`editar-${index}`).addEventListener('click',async () => {
                    const newTitle= prompt('Editar titulo del productos: ', producto.title)
                    console.log('Titulo nuevo', newTitle);
                    const productRef=doc(db,'productos',producto.id)
                    // se muestra en consola la referencia del producto
                    console.log('PRODUCT REF ',productRef);
                    // se muestra el id del producto para luego revisar en firestore
                    console.log('PRODUCT ID' , producto.id)
                    //actualizamos el titulo del producto                    
                    await updateDoc(productRef, {title:newTitle})
                        alert(`Titulo del producto cambiado por ${newTitle}`)
                })
                document.getElementById(`eliminar-${index}`).addEventListener('click', async () => {
                        if (confirm('Seguro que deseas eliminar este producto?')) {
                            await deleteDoc(doc(db,'productos', producto.id))
                        }
                })
            })
        }

        //  Funcion para guardar los productos en Firestore sin duplicar
        const saveToFirestore=async(productos)=>{
                try {
                    const productRef= collection(db, 'productos')

                    for (const producto of productos ) {
                       //Verificar si el producto ya existe en Firestore
                       const q= query(productRef, where("id","==", producto.id))
                       const querySnapshot= await getDocs(q)
                       if (querySnapshot.empty) {
                            await addDoc(productRef , {
                                "id": producto.id,
                                "title": producto.title,
                                "price": producto.price,
                                "description": producto.description,
                                "category": producto.category,
                                "image": producto.image,
                                "rating": producto.rating.rate
                            } )
                            console.log(`Producto guardado : ${producto.title}`);
                            
                        } else{
                           console.log(`El producto : ${producto.title} ya existe en Firestore`);
                       }
                    }
                    console.log('Todos los productos han sido procesados');
                    
                } catch (error) {
                    console.log('Error al guardar datos en Firestore');
                    
                }
           }
// Evento para ejecutar la importacion al hacer click en el boton
document.getElementById('importBtn').addEventListener('click', ()=>{
     getFakeStoreData()
})


      </script>
</body>
</html>